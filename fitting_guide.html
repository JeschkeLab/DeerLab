
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Fitting Guide &#8212; DeerLab</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="_static/theme_override.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Uncertainty Guide" href="uncertainty_guide.html" />
    <link rel="prev" title="Modeling Guide" href="modelling_guide.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="index.html">
  <img src="_static/logo_docs_paths.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <div class="container-fluid  px-0">
  
    <div class="navbar-collapse collapse navbar-collapse" id="navbar-collapsible">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link nav-link" href="installation.html">Installation</a>
        </li>

        <li class="dropdown">
          <a class="dropbtn" href="user_guide.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">User Guide</a>
          <div class="dropdown-content" aria-labelledby="navbarDropdown">
              <a class="nav-dropdown-item dropdown-item" href="basics.html">Basics</a>
              <a class="nav-dropdown-item dropdown-item" href="getting_started.html">Getting Started</a>
              <a class="nav-dropdown-item dropdown-item" href="dipolar_guide_modelling.html">Modelling</a>
              <a class="nav-dropdown-item dropdown-item" href="dipolar_guide_fitting.html">Fitting</a>
              <a class="nav-dropdown-item dropdown-item" href="theory.html">Theory</a>
          </div>
        </li>

        <li class="dropdown">
            <a class="dropbtn" href="advanced_guide.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Advanced Guides</a>
            <div class="dropdown-content" aria-labelledby="navbarDropdown">
                <a class="nav-dropdown-item dropdown-item" href="modelling_guide.html">Modelling Guide</a>
                <a class="nav-dropdown-item dropdown-item" href="#">Fitting Guide</a>
                <a class="nav-dropdown-item dropdown-item" href="uncertainty_guide.html">Uncertainty Guide</a>
            </div>
          </li>

        <li class="nav-item">
          <a class="nav-link nav-link" href="examples.html">Examples</a>
        </li>

        <li class="nav-item">
          <a class="nav-link nav-link" href="modelsref.html">Models</a>
        </li>

        
        <li class="nav-item">
            <a class="nav-link nav-link" href="reference.html">Reference</a>
          </li>

        <li class="dropdown">
          <a class="dropbtn nav-link dropdown-toggle" href="more.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">More</a>
          <div class="dropdown-content" aria-labelledby="navbarDropdown">
              <a class="nav-dropdown-item dropdown-item" href="changelog.html">Release Notes</a>
              <a class="nav-dropdown-item dropdown-item" href="contributing.html">Contributing</a>
              <a class="nav-dropdown-item dropdown-item" href="support.html">Support</a>
              <a class="nav-dropdown-item dropdown-item" href="license.html">License</a>
              <a class="nav-dropdown-item dropdown-item" href="https://github.com/JeschkeLab/DeerLab">GitHub</a>
              <a class="nav-dropdown-item dropdown-item" href="https://pypi.org/project/DeerLab/#history">Other Versions and Download</a>
          </div>
        </li>
      </ul>

    </div>
  </div>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="modelling_guide.html">
   Modeling Guide
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Fitting Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="uncertainty_guide.html">
   Uncertainty Guide
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-fit-function">
   The
   <code class="docutils literal notranslate">
    <span class="pre">
     fit
    </span>
   </code>
   function
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specifying-the-noise-level-s">
     Specifying the noise level(s)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-models-with-constants">
     Fitting models with constants
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-multi-dataset-models">
     Fitting multi-dataset models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adding-regularization">
   Adding regularization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-selection-functional">
     Changing the selection functional
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-optimization-range">
     Changing the optimization range
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#manual-specification">
     Manual specification
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adding-penalties">
   Adding penalties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#constructing-a-penalty">
     Constructing a penalty
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-gaussian-smoothness-penalty">
     Example: Gaussian smoothness penalty
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#manually-setting-the-penalty-weight">
     Manually setting the penalty weight
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examining-the-results">
   Examining the results
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-fitresult-object">
     The
     <code class="docutils literal notranslate">
      <span class="pre">
       FitResult
      </span>
     </code>
     object
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluating-and-propagating-from-the-results">
     Evaluating and propagating from the results
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="fitting-guide">
<span id="id1"></span><h1>Fitting Guide<a class="headerlink" href="#fitting-guide" title="Permalink to this headline">¶</a></h1>
<p>This guide will focus on the last step of the DeerLab workflow, i.e., the fitting. Due to the separation of non-linear parameters <img class="math" src="_images/math/8e9f8e664891f997469cb4ad9e5439e81d0660dc.svg" alt="\theta_\mathrm{nonlin}"/> and linear parameters <img class="math" src="_images/math/68a93297867e31caa33516d8d3534ab818c7e905.svg" alt="\theta_\mathrm{lin}"/> in the model structure of DeerLab, the program can use penalized separable non-linear least-squares to fit the model to the data. The fitting procedure aims to find the following optimization problem with the objective function</p>
<div class="math">
<p><img src="_images/math/0a669195c4e733f32c693cf9fd4a7e8dcebd67e4.svg" alt="\min_{\theta_\mathrm{nonlin}} \left\{ \Vert y - A(\theta_\mathrm{nonlin})\theta_\mathrm{lin}(\theta_\mathrm{nonlin}) \Vert^2  + \sum_i \gamma_i\mathcal{P}_i(\theta_\mathrm{nonlin},\theta_\mathrm{lin}) \right\} \\"/></p>
</div><p>with the linear part of the objective given by</p>
<div class="math">
<p><img src="_images/math/f2a2f74864f4b81b5b0096880839c879d86ec4fd.svg" alt="\theta_\mathrm{lin}(\theta_\mathrm{nonlin}) = {\arg\!\min}_{\theta} \left\{ \Vert y - A(\theta_\mathrm{nonlin})\theta \Vert^2 +  \alpha^2\mathcal{R}(\theta) \right\} \\"/></p>
</div><p>and all subject to the boundary conditions defined in the model</p>
<div class="math">
<p><img src="_images/math/c399199c56f71b63c379203f10eba352c504b0ff.svg" alt="\theta_\mathrm{lb} \leq \theta_\mathrm{nonlin} \leq \theta_\mathrm{ub} \quad\quad \theta_\mathrm{lbl} \leq \theta_\mathrm{lin} \leq \theta_\mathrm{ubl}"/></p>
</div><p>The term <img class="math" src="_images/math/9fa5636af77a9ff7c61943c7cddf370d0c09b274.svg" alt="A(\theta_\mathrm{nonlin})"/> is the non-linear function of the model. A regularization penalty <img class="math" src="_images/math/a2ea4e28b134adf895ee4d079b65868e160eb647.svg" alt="\mathcal{R}(\theta_\mathrm{lin})"/> weighted by a regularization weight or parameter <img class="math" src="_images/math/f36a3f8dbda6bea20079ecea63562c7932d00b1b.svg" alt="\alpha"/>, and multiple additional arbitrary penalty terms <img class="math" src="_images/math/c46422b33964608af7cf63390b465616f54031e9.svg" alt="\mathcal{P}_i(\theta_\mathrm{nonlin},\theta_\mathrm{lin})"/> each weighted by its own penalty weight <img class="math" src="_images/math/1befffcd1b819f2e5057daadfdb4d960e52b5f49.svg" alt="\gamma_i"/>, can be added to this objective function if wanted</p>
<section id="the-fit-function">
<h2>The <code class="docutils literal notranslate"><span class="pre">fit</span></code> function<a class="headerlink" href="#the-fit-function" title="Permalink to this headline">¶</a></h2>
<p>DeerLab provides a centralized fitting function called <code class="docutils literal notranslate"><span class="pre">fit</span></code>. Its syntax is generally straightforward, taking a dataset and a model to be fitted to it. The function will always return a <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> object containing all of the fitted quantities, including uncertainty estimates, as well as other quantities of interest. Assume that we have some dataset <code class="docutils literal notranslate"><span class="pre">y</span></code> described by some model called <code class="docutils literal notranslate"><span class="pre">model</span></code>. The fit can be executed as follows</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>If the model has parameters without assigned start values, the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function will return an error and request them to be specified. They can be passed via the <code class="docutils literal notranslate"><span class="pre">par0</span></code> keyword argument passing the start values as a list</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data with other start values</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">par0</span><span class="o">=</span><span class="n">par0_list</span><span class="p">)</span>
</pre></div>
</div>
<p>However, the list must be ordered according to the model parameter ordering. Therefore, we recommend specifying the start values on the model (as shown <a class="reference internal" href="modelling_guide.html#modelling-modifying-parameters"><span class="std std-ref">here</span></a>).</p>
<section id="specifying-the-noise-level-s">
<h3>Specifying the noise level(s)<a class="headerlink" href="#specifying-the-noise-level-s" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fit</span></code> function (and other functions in the pipeline) employ the noise level of the dataset(s), i.e. the standard deviation of the white Gaussian noise superimposed on the data, at various stages of the model optimization and uncertainty estimation. Therefore, the analysis profits strongly from accurate estimates of the noise level(s). These can be specified via the <code class="docutils literal notranslate"><span class="pre">noiselvl</span></code> keyword argument of the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">yclean</span> <span class="o">+</span> <span class="n">dl</span><span class="o">.</span><span class="n">whitegaussnoise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="c1"># Fit the model (with two constants) to the data</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">constant1</span><span class="p">,</span> <span class="n">constant2</span><span class="p">,</span> <span class="n">noiselvl</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
<p>IF not specified, the program will estimate it from the dataset(s) directly using the <a class="reference internal" href="_autosummary/deerlab.noiselevel.html#noiselevel"><span class="std std-ref">deerlab.noiselevel</span></a> function. While, these estimates can be relatively accurate, it is better to specify the noise level if a trusted estimate is known.</p>
</section>
<section id="fitting-models-with-constants">
<h3>Fitting models with constants<a class="headerlink" href="#fitting-models-with-constants" title="Permalink to this headline">¶</a></h3>
<p>Models with constants (see <a class="reference internal" href="modelling_guide.html#modelling-constants"><span class="std std-ref">here</span></a> for details) can be fitted as shown above, with the added requirement that the constants must be specified as well when calling <code class="docutils literal notranslate"><span class="pre">fit</span></code>. Constants can be specified after the data as positional arguments</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model (with two constants) to the data</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">constant1</span><span class="p">,</span> <span class="n">constant2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fitting-multi-dataset-models">
<h3>Fitting multi-dataset models<a class="headerlink" href="#fitting-multi-dataset-models" title="Permalink to this headline">¶</a></h3>
<p>Models merged using the <code class="docutils literal notranslate"><span class="pre">merge</span></code> function (see <a class="reference internal" href="modelling_guide.html#modelling-merging"><span class="std std-ref">here</span></a> for details) can describe multiple datasets with a single model object and a common parameter set. To fit such a merged model to multiple datasets, the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function can be used as above by passing a list of datasets <code class="docutils literal notranslate"><span class="pre">[y1,y2,...,yN]</span></code> instead of a single dataset</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to multiple datasets</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="p">]</span>
</pre></div>
</div>
<p>The number of datasets must match the number of responses returned by the model. Additionally, the ordering in the list of datasets must match the order of responses from the model, i.e. <code class="docutils literal notranslate"><span class="pre">response1</span></code> of <code class="docutils literal notranslate"><span class="pre">model</span></code> will be fitted to <code class="docutils literal notranslate"><span class="pre">y1</span></code>, and so on.</p>
</section>
</section>
<section id="adding-regularization">
<h2>Adding regularization<a class="headerlink" href="#adding-regularization" title="Permalink to this headline">¶</a></h2>
<p>DeerLab includes the possibility to impose (Tikhonov) regularization based on the smoothness of the linear parameters in the model. By default, DeerLab will automatically check the condition number of the matrix returned by the non-linear part of the model and determine whether it is well-conditioned or not. If the matrix is ill-conditioned, the program will automatically enforce regularization upon the linear parameters.
Regularization can be manually be switched on/off via the <code class="docutils literal notranslate"><span class="pre">reg</span></code> param</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enforce regularization</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Disable regularization</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The regularization penalty weight (a.k.a regularization parameter) is optimally selected according to a given criterion (by default, the Akaike information criterion, AIC). There are different ways to control this process:</p>
<section id="changing-the-selection-functional">
<h3>Changing the selection functional<a class="headerlink" href="#changing-the-selection-functional" title="Permalink to this headline">¶</a></h3>
<p>The regularization functional can be changed from the AIC to any built-in functionals via the <img class="math" src="_images/math/43e847293a04eb1bd90bec393f433291bae5d9db.svg" alt="regparam"/> keyword argument. Changing it to another functional will only change how the regularization parameter is selected, but it still will be optimized. For example, to switch the selection functional from the AIC to generalized cross-validation (GCV)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data, using the GCV criterion</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">regparam</span><span class="o">=</span><span class="s1">&#39;gcv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A list of the available selection functionals and their string names are given in the reference for <code class="docutils literal notranslate"><span class="pre">fit</span></code>.</p>
</section>
<section id="changing-the-optimization-range">
<h3>Changing the optimization range<a class="headerlink" href="#changing-the-optimization-range" title="Permalink to this headline">¶</a></h3>
<p>When using selection functionals to optimize the regularization weights, a Brent-like algorithm searches the value that minimizes the given selection functional within a specific range. This range can be manually specified via the <code class="docutils literal notranslate"><span class="pre">regparamrange</span></code> keyword argument. It must be passed as a two-element list <code class="docutils literal notranslate"><span class="pre">[regparam_lb,</span> <span class="pre">regparam_ub]</span></code> with the search boundaries</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data, with a constrained regparam search range</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">regparamrange</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">1e-1</span><span class="p">])</span>
</pre></div>
</div>
<p>This can be useful for avoiding unwanted local minima of the selection functional causing potential under- or oversmoothing.</p>
</section>
<section id="manual-specification">
<h3>Manual specification<a class="headerlink" href="#manual-specification" title="Permalink to this headline">¶</a></h3>
<p>The value of the regularization penalty weight can also be manually specified and fixed to a value for the whole optimization. This can be done via the aforementioned <code class="docutils literal notranslate"><span class="pre">regparam</span></code> keyword argument by specifying a value instead of a selection functional</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data, using a fixed regularization weight</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">regparam</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="adding-penalties">
<h2>Adding penalties<a class="headerlink" href="#adding-penalties" title="Permalink to this headline">¶</a></h2>
<p>DeerLab provides a flexible system for defining and adding penalties to the objective function of the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function in the form of the <code class="docutils literal notranslate"><span class="pre">Penalty</span></code> objects, which can be passed to the <code class="docutils literal notranslate"><span class="pre">penalties</span></code> keyword argument of the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model to the data with an additional penalty</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span> <span class="n">penalties</span><span class="o">=</span><span class="n">penalty</span><span class="p">)</span>
</pre></div>
</div>
<p>Penalties are only added to the non-linear part of the separable non-linear least-squares objective function used in <code class="docutils literal notranslate"><span class="pre">fit</span></code>. For the linear part, only Tikhonov regularization can be imposed (see the previous section).</p>
<p>DeerLab’s penalties consist of the following components:</p>
<dl class="simple">
<dt>Penalty function</dt><dd><p>The penalty function takes model parameters and returns a vector of values that are appended to the least-squares residual. The function should ideally be convex, monotonically increasing, and defined everywhere. It can be freely constructed and defined.</p>
</dd>
<dt>Penalty weight</dt><dd><p>As its name indicates, the penalty weight balances the influence of the penalty with respect to the other terms in the objective function. It is treated similarly to model parameters, meaning that it has boundaries defined that can be manipulated freely.</p>
</dd>
<dt>Selection functional</dt><dd><p>The selection criterion desired for the optimized choice of penalty weight. Must be chosen from a collection of selection functionals.</p>
</dd>
</dl>
<section id="constructing-a-penalty">
<h3>Constructing a penalty<a class="headerlink" href="#constructing-a-penalty" title="Permalink to this headline">¶</a></h3>
<p>Penalties can be constructed in a similar way to <a class="reference internal" href="modelling_guide.html#modelling-construction"><span class="std std-ref">how models are constructed</span></a>. Since penalties depend on a model’s parameters, and by extension, are specific for a given model, it is recommended to construct penalties after the model has been entirely constructed.</p>
<p>The first step is to construct the penalty function. First, it must be a callable function taking a series of positional arguments. The names of the arguments must match the names of the model parameters that the penalty depends on. Second, the function must return a vector, taking the following into account:</p>
<ul class="simple">
<li><p>The vector cannot change length/shape for different parameter combinations.</p></li>
<li><p>The program will internally compute the squared values and append the vector to the residual vector.</p></li>
<li><p>The penalty weight must not be included in the penalty function definition. It is accounted for internally upon constructing the penalty.</p></li>
</ul>
<p>Third, a selection functional for the optimal selection of the penalty weight must be chosen from a list of built-in functionals:</p>
<ul class="simple">
<li><p>Informational complexity criterion (<code class="docutils literal notranslate"><span class="pre">icc</span></code>)</p></li>
<li><p>Akaike complexity criterion (<code class="docutils literal notranslate"><span class="pre">aic</span></code>)</p></li>
<li><p>Bayesian complexity criterion (<code class="docutils literal notranslate"><span class="pre">aic</span></code>)</p></li>
<li><p>Corrected Akaike complexity criterion (<code class="docutils literal notranslate"><span class="pre">aicc</span></code>)</p></li>
</ul>
<p>Last, the penalty can be constructed using the <code class="docutils literal notranslate"><span class="pre">Penalty()</span></code> constructor passing the penalty function and selection functional</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the penalty function</span>
<span class="k">def</span> <span class="nf">penalty_fcn</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span><span class="n">param2</span><span class="p">,</span><span class="n">param3</span><span class="p">):</span>
    <span class="c1"># compute something...</span>
    <span class="k">return</span> <span class="n">penalty_vector</span>
<span class="n">penaltyobj</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Penalty</span><span class="p">(</span><span class="n">penalty_fcn</span><span class="p">,</span><span class="s1">&#39;aic&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Upon constructing the penalty, the penalty weight is introduced in the background. This can be accessed via the <code class="docutils literal notranslate"><span class="pre">&lt;Penalty&gt;.weight</span></code> attribute. The <code class="docutils literal notranslate"><span class="pre">weight</span></code> attribute is a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> object similar in behavior to model parameters, with the difference that it has no <code class="docutils literal notranslate"><span class="pre">linear</span></code> or <code class="docutils literal notranslate"><span class="pre">par0</span></code> attributes. Otherwise, its boundaries and other descriptors can be freely modified.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set boundaries for the penalty weight</span>
<span class="n">penaltyobj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
<span class="c1"># Set a new description for the penalty weight</span>
<span class="n">penaltyobj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">desciption</span> <span class="o">=</span> <span class="s1">&#39;A penalty weight&#39;</span>
</pre></div>
</div>
</section>
<section id="example-gaussian-smoothness-penalty">
<h3>Example: Gaussian smoothness penalty<a class="headerlink" href="#example-gaussian-smoothness-penalty" title="Permalink to this headline">¶</a></h3>
<p>In this example, let us construct a penalty that imposes the smoothness of a Gaussian function. As a model, we will take the <code class="docutils literal notranslate"><span class="pre">gauss</span></code> model defined in <a class="reference internal" href="modelling_guide.html#modelling-example1"><span class="std std-ref">another example</span></a>. The function has to penalize roughness for imposing smoothness, which can be quantified by a discrete differential operator of second order (which we can generate using DeerLab’s <code class="docutils literal notranslate"><span class="pre">regoperator</span></code>). As a selection criterion, we will use the AIC functional.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Differential operator of second order</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">regoperator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Define the penalty function</span>
<span class="k">def</span> <span class="nf">smoothness_fcn</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">std</span><span class="p">):</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>
    <span class="n">penalty_vector</span> <span class="o">=</span> <span class="n">L</span><span class="nd">@gaussian</span>
    <span class="k">return</span> <span class="n">penalty_vector</span>
<span class="c1"># Construct the penalty</span>
<span class="n">smoothness</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">Penalty</span><span class="p">(</span><span class="n">smoothness_fcn</span><span class="p">,</span><span class="s1">&#39;aic&#39;</span><span class="p">)</span>

<span class="c1"># Fit the model to the data with a smoothness penalty</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span><span class="n">y</span> <span class="n">penalties</span><span class="o">=</span><span class="n">smoothness</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="manually-setting-the-penalty-weight">
<h3>Manually setting the penalty weight<a class="headerlink" href="#manually-setting-the-penalty-weight" title="Permalink to this headline">¶</a></h3>
<p>By default, the program will use the specified selection functional to optimize the value of the penalty weights in an outer optimization approach. The search range of this optimization routine is given by the boundaries <code class="docutils literal notranslate"><span class="pre">[weight.lb,</span> <span class="pre">weight.ub]</span></code> of the penalty weight. However, the penalty weight can be fixed to a specific value using the <code class="docutils literal notranslate"><span class="pre">freeze</span></code> method of the <code class="docutils literal notranslate"><span class="pre">weight</span></code> attribute</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use a fixed penalty weight</span>
<span class="n">penaltyobj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="c1"># Fit the model to the data</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span><span class="n">y</span> <span class="n">penalties</span><span class="o">=</span><span class="n">penaltyobj</span><span class="p">)</span>
</pre></div>
</div>
<p>This will fix the value throughout the whole fitting approach and skip the outer optimization entirely (if no other penalties are passed).</p>
</section>
</section>
<section id="examining-the-results">
<span id="fitting-fitresult"></span><h2>Examining the results<a class="headerlink" href="#examining-the-results" title="Permalink to this headline">¶</a></h2>
<p>A summary of the fit can be accessed by printing the <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> object as returned by the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;print(result)</span>
<span class="go">Goodness-of-fit:</span>
<span class="go">========= ============= ============ ======= ===========</span>
<span class="go">Dataset   Noise level   Reduced 𝛘2   RMSD       AIC</span>
<span class="go">========= ============= ============ ======= ===========</span>
<span class="go">   #1         0.049        1.058      0.050   -3002.842</span>
<span class="go">========= ============= ============ ======= ===========</span>
<span class="go">Model parameters:</span>
<span class="go">=========== ======= ========================= ======= ================</span>
<span class="go"> Parameter   Value   95%-Confidence interval   Units   Description</span>
<span class="go">=========== ======= ========================= ======= ================</span>
<span class="go"> center      5.002   (4.995,5.010)             None    None</span>
<span class="go"> std         0.204   (0.196,0.212)             None    None</span>
<span class="go"> scale       0.999   (0.999,0.999)             None    Scaling factor</span>
<span class="go">=========== ======= ========================= ======= ================</span>
</pre></div>
</div>
<section id="the-fitresult-object">
<h3>The <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> object<a class="headerlink" href="#the-fitresult-object" title="Permalink to this headline">¶</a></h3>
<p>Once the fitting routine is finished, the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function will return a <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> object containing multiple quantities of interest.</p>
<dl class="simple">
<dt>Estimated parameters (<code class="docutils literal notranslate"><span class="pre">FitResult.&lt;param&gt;</span></code>)</dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> will contain an attribute <code class="docutils literal notranslate"><span class="pre">&lt;param&gt;</span></code> of the same name as each parameter in the model. This will be the estimated maximum likelihood estimator of the model parameter for the given data and penalties.</p>
</dd>
<dt>Estimated parameter uncertainty (<code class="docutils literal notranslate"><span class="pre">FitResult.&lt;param&gt;Uncert</span></code>)</dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> will contain an attribute <code class="docutils literal notranslate"><span class="pre">&lt;param&gt;Uncert</span></code> of the same name as each parameter in the model. This will contain the full uncertainty estimate of the parameter in the form of an <code class="docutils literal notranslate"><span class="pre">UQResult</span></code> object (see here for details).</p>
</dd>
<dt>Estimated model response (<code class="docutils literal notranslate"><span class="pre">FitResult.model</span></code>)</dt><dd><p>It is the maximum likelihood estimate of the model’s response. It can be computed as well from the model and the fitted parameter values.</p>
</dd>
<dt>Estimated model response (<code class="docutils literal notranslate"><span class="pre">FitResult.modelUncert</span></code>)</dt><dd><p>The uncertainty estimate of the model’s response in the form of an <code class="docutils literal notranslate"><span class="pre">UQResult</span></code> object propagated from the uncertainty on the parameters.</p>
</dd>
<dt>Statistical descriptors (<code class="docutils literal notranslate"><span class="pre">FitResult.stats</span></code>)</dt><dd><p>A dictionary of statistical quantities such as reduced chi-square, RMSD or AIC values quantifying the goodness-of-fit and model complexity. The reduced chi-square statistic <code class="docutils literal notranslate"><span class="pre">FitResult.stats['chi2red']</span></code> allows the assessment of whether the fit describes the data or not. A comparable value to 1 will indicate a good fit of the input data. The AIC <code class="docutils literal notranslate"><span class="pre">FitResult.stats['aic']</span></code> and other information-based quantities allow the comparison between fits based on alternate models and selecting the most appropriate model.</p>
</dd>
<dt>Penalty and regularization weights (<code class="docutils literal notranslate"><span class="pre">FitResult.regparam</span></code> and <code class="docutils literal notranslate"><span class="pre">FitResult.penweights</span></code>)</dt><dd><p>Contain the regularization and penalty values used to find the maximum likelihood estimator.</p>
</dd>
</dl>
</section>
<section id="evaluating-and-propagating-from-the-results">
<h3>Evaluating and propagating from the results<a class="headerlink" href="#evaluating-and-propagating-from-the-results" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">FitResul</span></code> object provides commodity methods <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> and <code class="docutils literal notranslate"><span class="pre">propagate</span></code> to quickly evaluate other models that might depend on the fitted parameters and propagate the uncertainty in the parameter estimates to those models. To evaluate a model <code class="docutils literal notranslate"><span class="pre">modelB</span></code> that shares parameters with <code class="docutils literal notranslate"><span class="pre">modelA</span></code> (which has been fitted), we can use the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit modelA to the data</span>
<span class="n">fitresult</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelA</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="c1"># Evaluate modelB at the fitted parameters</span>
<span class="n">responseB</span> <span class="o">=</span> <span class="n">fitresult</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">modelB</span><span class="p">)</span>
</pre></div>
</div>
<p>Similarly, to propagate the uncertainty from the fitted parameters to <code class="docutils literal notranslate"><span class="pre">modelB</span></code> we can use the <code class="docutils literal notranslate"><span class="pre">propagate</span></code> method. This method takes additionally the optional keyword arguments <code class="docutils literal notranslate"><span class="pre">lb</span></code> and <code class="docutils literal notranslate"><span class="pre">ub</span></code> to specify any boundaries on the response <code class="docutils literal notranslate"><span class="pre">responseB</span></code> of <code class="docutils literal notranslate"><span class="pre">modelB</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit modelA to the data</span>
<span class="n">fitresult</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelA</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="c1"># Propagate the uncertainty to responseB (responseB is non-negative)</span>
<span class="n">responseBUncert</span> <span class="o">=</span> <span class="n">fitresult</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">modelB</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">responseB</span><span class="p">))</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">modelB</span></code> has any constants defined in the model, these must be specified as positional arguments after the model for both <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> and <code class="docutils literal notranslate"><span class="pre">propagate</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit modelA to the data</span>
<span class="n">fitresult</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelA</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="c1"># Evaluate model with two constants</span>
<span class="n">responseB</span> <span class="o">=</span> <span class="n">fitresult</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">modelB</span><span class="p">,</span> <span class="n">constant1</span><span class="p">,</span> <span class="n">constant2</span><span class="p">)</span>
<span class="c1"># Propagate the uncertainty to model with two constants</span>
<span class="n">responseBUncert</span> <span class="o">=</span> <span class="n">fitresult</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">modelB</span><span class="p">,</span> <span class="n">constant1</span><span class="p">,</span> <span class="n">constant2</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that for <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> and <code class="docutils literal notranslate"><span class="pre">propagate</span></code> to work, all the parameters of <code class="docutils literal notranslate"><span class="pre">modelB</span></code> must be contained in the <code class="docutils literal notranslate"><span class="pre">FitResult</span></code> object.</p>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="modelling_guide.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Modeling Guide</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="uncertainty_guide.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Uncertainty Guide</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2019-2022, Luis Fábregas-Ibáñez, Stefan Stoll, and others.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>