<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB R2019b"><title>Fitting a custom time-domain model of a 4-pulse DEER signal</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(213, 80, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 15px; font-weight: 700; text-align: left;  }
.S2 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S3 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F7F7F7; margin: 10px 0 10px 0;}
.S4 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 1px solid rgb(233, 233, 233); border-bottom: 0px none rgb(0, 0, 0); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S5 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 0px none rgb(0, 0, 0); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S6 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 1px solid rgb(233, 233, 233); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S7 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S8 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S9 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Fitting a custom time-domain model of a 4-pulse DEER signal</span></h1><h4  class = 'S1'><span>Author: Luis Fabregas</span></h4><div  class = 'S2'><span>In this example we will construct a time-domain parametric model describing our full 4-pulse DEER signal (that means distribution + background + other time-domain parameters) using the built-in parametric models. We will then use this model to fit our full parametric model to our signal in one step.</span></div><h2  class = 'S3'><span>Generating a dipolar signal</span></h2><div  class = 'S2'><span>Let's start by simulating a dipolar signal, whose parameters we know. For this example we will use a dipolar signal with a modulation depth of 27% originating from a Gaussian distance distribution (mean distance of 3.5 </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span> and width of 0.3 </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span>) with a stretched exponential background model with a decay rate of 0.15</span><span texencoding="\mu s^{-1}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAAmCAYAAAB6beP2AAADXUlEQVRoQ+3YW8ilUxwG8N8wkXMukEPJheSGi6GUUyLRlEOJcpZxJqcSSskxF2gKMTMunA9RTndSMplwh4uhkUhGZJghh+TUo/XW6m3v/e2vvfc7vv3tdbNrv+td63nW//9//s96l1hEY8ki4mpGdlqjPYvsLLL/7xPYBsfiUtyOT3vBXehpHPyH4gqcga9w1jST3Z7/usqDOGKayTbZusOMbKtwF3rNziI7rQK1ICN7G+4YspU/huvxWzV/QQnUwdhrSLKb8TH+mgTZ7bBLWfhn/NECtTPS6/7GlvI7JO6xTRtbZE/Bq1iHs/FlBTGH8DDOK33u5h6HsQeuwfF4G7vhG+QQf8DKMVAeC9ltcSduwVO4ColuMw7CC8WynYtnWsB3R2rsKJyGDxAfewkexal4bQxkdyyHdvgoDipRWFN85w0lejW2JuobypyPWsCX4XV8jzPxSXm+D57GrXhvRLKp95NwLfbHvXgZH+LPeu25TMUheAkH4kS8Wb1cRz1zVpSarddvyO5dbiQ5uH+QtMvtZDU+G5Hs0K/PRXZQvYbAkzihnGbaR62QAZE0fhyn431chPVDoxvzxEFk68glIkmTX6v9Ly4pnr8G1V6epd4jZhG6y/DtmHkMtdwgsolKQC5Hu173Lc+OK7XR9w6JpYhKR+gyHsJNLVMwFNhRJw0iW9drvgK8UzZLxK8rgPfso9JtXDEMUeVEOWqetH5rVPDzfX8Q2UTr+R79NcTPx35FtFKrdxfhafbPJXoTotLNOKasl1qPYvaq8fnin9f8fmTren2lCEtsWmQ+QJ/FXZVKx3BciSfwXSES8xEBa0ZtQB7Bjfh9XmhHnNyPbF2vUdE4pCht3E6MQ9pHE/WYiSPL8/wX63g/0uivxi8FY+NyIlBpU1HpTkc/snW9NoBSaxGZfOuJo8otJY17bfnQ9UBp4k0E45guQDIjh5OseA5fbC1F7ke2qdfPkZT+CfcUgxFXcnTxxLsW8qsqdY0Xvg9vFIIH4EcchhdLajfR3uqRrev18qKinYKa1Ga9ItvUa9TzZLw7qc27XrcX2aZev8Y52Ng1qEnt14tsCOZG0uvzx6RwdLJum+xOxc5diKmq15xmm2wUM84mn17SXjq7fnUR2rmueF1g6GyPRUX2X/wiwSdecYEjAAAAAElFTkSuQmCC" width="29.5" height="19" /></span><span> and a dimensionality of 2.8.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>clc,clf,clear</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Define the parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>rmean = 3.5; </span><span style="color: rgb(60, 118, 61);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>w = 0.3; </span><span style="color: rgb(60, 118, 61);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>lam = 0.27;</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>k = 0.15; </span><span style="color: rgb(60, 118, 61);">%us-1</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>d = 2.8;</span></span></div></div></div><div  class = 'S7'><span>We will simulate the dipolar signal on a time-axis defined between -0.2</span><span texencoding="\mu s" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAkCAYAAAAD3IPhAAACx0lEQVRYR+3WW6hOaRwG8N9mosGQC2S4cSG54cJcKKdEalJj1ETNOIYhh5iZElNTwoxcGCkjx4txJhczuJMSEXPHDaKJJmRyGCZDcupf79Lan7X2/vaevbd98b03X613ff//83/e53neVacdrbp2hEUNTNlp1JipMdNUp9Y0U9NMTTNNZeD/aKYTPkoF/sXzimLd0Bmv8Cj9NgtfNdb+DL/jHL7EzVynAPkLpmMjVhSA7YUlGIdT6IE7iCEfYFNWrzEwHbEGK7EHixDsZGsQDmEopmFfBSU9sQ0j8Tn+QAfMw1ZMwtFqwcQUO/EFvk3T5/tlrF1L71yqADMMx3APU3Al7X+Mvfge56sFMwRHMBATcCLXLM9avDM3aSaPJwPTF1+nwV7jQ6zCDlyvFkxDeokGuzEe6/ADXhYc0y5MxgXMxuXmuCk/eRzVUvyXKzQnTRqP6p19RbPYC72F2MMI83G3CFBDAg7xRZGJBXrpl/bG4iKm4mrJxB8kl4URYm3GcjytfL8hMHm9jMHp9OdgbFkq2LvEZZV9+iRXBUvhxji2k00BE9MeLMiXADYD/ZOoQys/IoSZreG4j3BZtkaneqG1Qo2VMZPXy29JeP9gcCq0H2tzLotAXIhf8XcSc4RjCDxb+YDcgu/wLM9OGZi8XsIFkbDhlEjLCLZgIWMtwm5E2o9ncTVsQBcsxpPUMOwcKR0CjhgIl9VbZWDyesn+EGcdIoyCkcirk3jP4C/8jBfJNXFFROLORDAb4IPVA7hR5qgyMJle/kQc2WP8lAIwGo5Kd1L3BG57zh1xF63H8QRgAB7iExxOR5ex1Sgzeb0sSC4ocW3LPi5iJtNLqP9TnG3ZluXVisBkermFr3D7fYIJAHGjxtX/TVFStha4Sma6priehTbVSwxYCSYUH4kan5Zh37fXe2uxUU3otUXvd3o09tnZpqDeAMu3nCW+fRnhAAAAAElFTkSuQmCC" width="17.5" height="18" /></span><span> and 4.0</span><span texencoding="\mu s" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAkCAYAAAAD3IPhAAACx0lEQVRYR+3WW6hOaRwG8N9mosGQC2S4cSG54cJcKKdEalJj1ETNOIYhh5iZElNTwoxcGCkjx4txJhczuJMSEXPHDaKJJmRyGCZDcupf79Lan7X2/vaevbd98b03X613ff//83/e53neVacdrbp2hEUNTNlp1JipMdNUp9Y0U9NMTTNNZeD/aKYTPkoF/sXzimLd0Bmv8Cj9NgtfNdb+DL/jHL7EzVynAPkLpmMjVhSA7YUlGIdT6IE7iCEfYFNWrzEwHbEGK7EHixDsZGsQDmEopmFfBSU9sQ0j8Tn+QAfMw1ZMwtFqwcQUO/EFvk3T5/tlrF1L71yqADMMx3APU3Al7X+Mvfge56sFMwRHMBATcCLXLM9avDM3aSaPJwPTF1+nwV7jQ6zCDlyvFkxDeokGuzEe6/ADXhYc0y5MxgXMxuXmuCk/eRzVUvyXKzQnTRqP6p19RbPYC72F2MMI83G3CFBDAg7xRZGJBXrpl/bG4iKm4mrJxB8kl4URYm3GcjytfL8hMHm9jMHp9OdgbFkq2LvEZZV9+iRXBUvhxji2k00BE9MeLMiXADYD/ZOoQys/IoSZreG4j3BZtkaneqG1Qo2VMZPXy29JeP9gcCq0H2tzLotAXIhf8XcSc4RjCDxb+YDcgu/wLM9OGZi8XsIFkbDhlEjLCLZgIWMtwm5E2o9ncTVsQBcsxpPUMOwcKR0CjhgIl9VbZWDyesn+EGcdIoyCkcirk3jP4C/8jBfJNXFFROLORDAb4IPVA7hR5qgyMJle/kQc2WP8lAIwGo5Kd1L3BG57zh1xF63H8QRgAB7iExxOR5ex1Sgzeb0sSC4ocW3LPi5iJtNLqP9TnG3ZluXVisBkermFr3D7fYIJAHGjxtX/TVFStha4Sma6priehTbVSwxYCSYUH4kan5Zh37fXe2uxUU3otUXvd3o09tnZpqDeAMu3nCW+fRnhAAAAAElFTkSuQmCC" width="17.5" height="18" /></span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>t = linspace(-0.2,4,300);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>r = time2dist(t);</span></span></div></div></div><div  class = 'S7'><span>Now we can generate the signal with some added noise</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the distance distribution</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>P = rd_onegaussian(r,[rmean w]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the background</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>B = td_strexp(t,[k d]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the signal</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>V = dipolarsignal(t,r,P,</span><span style="color: rgb(160, 32, 240);">'moddepth'</span><span>,lam,</span><span style="color: rgb(160, 32, 240);">'background'</span><span>,B,</span><span style="color: rgb(160, 32, 240);">'noiselevel'</span><span>,0.01);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(t,V)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>xlabel(</span><span style="color: rgb(160, 32, 240);">'time [\mus]'</span><span>),ylabel(</span><span style="color: rgb(160, 32, 240);">'V(t)'</span><span>)</span></span></div></div></div><h2  class = 'S3'><span>Defining the time-domain model</span></h2><div  class = 'S2'><span>This is probably the most crucial step: defining the model. How well a signal can be fitted depends mainly on how well the model can describe our signal. In order to fit our time-domain dipolar signal in one step, we require a model which contains the information on the distance distribution, the background and modlation depth. Even tough such a mode is not implemented as a function in the program, we can easily define our own model using the built-in parametric models.</span></div><div  class = 'S2'><span>In this case we know the groun truth, so we will construct our time-domain model according to </span></div><div  class = 'S2'><span mathmlencoding="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow&gt;&lt;mi mathvariant=&quot;bold-italic&quot;&gt;V&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;-&lt;/mo&gt;&lt;mi&gt;λ&lt;/mi&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;mi&gt;λ&lt;/mi&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;KP&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;⊙&lt;/mo&gt;&lt;mi mathvariant=&quot;bold-italic&quot;&gt;B&lt;/mi&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;/mrow&gt;&lt;/math&gt;" style="vertical-align:-5px"><img src="data:image/png;base64,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" width="172" height="19" /></span></div><div  class = 'S2'><span>where the background </span><span texencoding="\mathbf{B}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAkCAYAAACXOioTAAABzUlEQVRIS+3WT4RWURgG8N8YSkZat2m0yqymFsksaxGzqDaR0TRTi2Q2MaJNMmSiIolKi8RoRmmIZhFJ1KJFi+nfpnWUKI1IMkR5OXHcvvvN/b65vjTmcjfnz/Oc85znfc7p0qGvq0M8VonaVnrlS7cPJ7AV6xvotIA32IQP6X+CB3iPX2XaNpIu2nbiJnqzia8xhLdYi2FcyhZ0DacRi/nrKzujDbiB/dmMhziIL6mtB1dwOBsTZCfxvchURrQurfZYE6LoGsFUNuYbBvGsbqIDuFMADUln6ibai/udIIozm86IPmIP5uvcUTjvAo5noGGOMMOPuoiK9g5LT+J6I5IgbcV1UT93U20NYAve4Sxm8bVZELZC9DyBhoX7cATbE3j0XcY9LLZSsFXqKCLqPMYy4Fspwj7XdUZ/cDbjNnZkwBdxqrizVqQrRlBgr8E5jC9l8eUSBX4E6Zmliva/IYqFTqQ/39RuPMoblrujcN5VHMpA53AUn6oQVbmPAmdXyrqNCTQKeBRPq9i77IaNwIz75zG6E0lkXX8CjfbIuRdVCjbeDKH5tmZxkvoiIV6l1YdcL/GzbN7Kf25VUKy9IavStadbkxu2bcB/bu/fJKl9JePlgUUAAAAASUVORK5CYII=" width="13" height="18" /></span><span> will be modeled by a stretched exponential time-domain model (</span><span style=' font-family: monospace;'>td_strexp</span><span>) and the distribution </span><span texencoding="\mathbf{P}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAkCAYAAACTz/ouAAABdUlEQVRIS+3WIUidURQH8J8rpoWxZlkatq0Oi8qQRa0yliYaBMGtGESYJgUxW2QqCoOB2HRFDIJNTKJlGxYVDLKwIOo4ch9cHu/tU54vqO+kj/Ode/6c//mfc2+TOltTnfNrABQy/PAo6sYI3hTWzjaOsIl17OOy/FwlisLXg3k8zQ5s4CN+4ln6HstiFjCKwxykWg9asISOLHgWw/ibfM2YwlAWs4oBHJd81QCeJ4B3/wGIX134UUbLZ8zgKvy1ArzCd7zMQBYxiD93AdCKb3idAUTD3+O0XgBRUR/O7gIg5Bw9yNU2gS+4qBUg+heqms7o2UUv9mpVUSTvxBxepGS/8QkrJQXdtoItrCXlteNtShxqCd7H8esmkxwxleagBHCe+A0aTnBQamil9VLrHBSurAbAI6YohmcZbdW2ZCE3KaCSip7gA76WJQnd9yPm4XrX38TKAeJOnkSs4Wq2k5ZZ3F6F9vCeLYUl3zagQVEhY/efon8CqGclCfN3YAAAAABJRU5ErkJggg==" width="12" height="18" /></span><span> will be modeled by a single Gaussian distribution (</span><span style=' font-family: monospace;'>rd_onegaussian</span><span>)</span></div><div  class = 'S2'><span>We can build the model by defining an anonymous function handle </span><span style=' font-family: monospace;'>model</span><span>, which must first accept the time axis </span><span style=' font-family: monospace;'>t</span><span> and the parameters </span><span style=' font-family: monospace;'>par</span><span>. The parameters of our model must be defined on a vector </span><span style=' font-family: monospace;'>par</span></div><ul  class = 'S8'><li  class = 'S9'><span style=' font-family: monospace;'>par(1) -&gt; lam</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(2) -&gt; rmean</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(3) -&gt; w</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(4) -&gt; k</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(5) -&gt; d</span></li></ul><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Define our time-domain model</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*rd_onegaussian(r,par(2:3))).*td_strexp(t,par(4:5));</span></span></div></div></div><h2  class = 'S3'><span>Fitting the model</span></h2><div  class = 'S2'><span>At this point our model is ready to be fitted. The only remaining step remaining is to define the initial values of the model parameters. Since it is a custom model, all parameter values will be unbounded so it is recommended to set some upper/lower boundaries for them. All three values can be defined as vectors with the same order as in the </span><span style=' font-family: monospace;'>par</span><span> vector. All these values can be well-estimated by visual inspection of the data.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">% Parameter lam rmean  w   k   d</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">% Index      1    2    3   4   5</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>par0 =     [0.35 4.0 0.4  0.1 3.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>lower =    [0.10 2.0 0.1  0.0 2.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>upper =    [0.50 7.0 0.5  0.3 4.0];</span></span></div></div></div><div  class = 'S7'><span>Finally we can launch the fitting function to obtain our fitted model parameters.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Launch the fit</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>fitpar = fitparamodel(V,model,t,par0,</span><span style="color: rgb(160, 32, 240);">'lower'</span><span>,lower,</span><span style="color: rgb(160, 32, 240);">'upper'</span><span>,upper);</span></span></div></div></div><div  class = 'S7'><span>We can now obtain the fitted models, and compare the fit parameters to our input parameters:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Get the fits</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>Vfit = model(t,fitpar);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>Pfit = rd_onegaussian(r,fitpar(2:3));</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Plot results</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>subplot(121)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(t,V,</span><span style="color: rgb(160, 32, 240);">'k.'</span><span>,t,Vfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>subplot(122)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(r,P,</span><span style="color: rgb(160, 32, 240);">'k'</span><span>,r,Pfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>round(par,2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>round(fitpar,2)</span></span></div></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Fitting a custom time-domain model of a 4-pulse DEER signal
% Author: Luis Fabregas
% In this example we will construct a time-domain parametric model describing 
% our full 4-pulse DEER signal (that means distribution + background + other time-domain 
% parameters) using the built-in parametric models. We will then use this model 
% to fit our full parametric model to our signal in one step.
%% Generating a dipolar signal
% Let's start by simulating a dipolar signal, whose parameters we know. For 
% this example we will use a dipolar signal with a modulation depth of 27% originating 
% from a Gaussian distance distribution (mean distance of 3.5 $nm$ and width of 
% 0.3 $nm$) with a stretched exponential background model with a decay rate of 
% 0.15$\mu s^{-1}$ and a dimensionality of 2.8.

clc,clf,clear

%Define the parameters
rmean = 3.5; %nm
w = 0.3; %nm
lam = 0.27;
k = 0.15; %us-1
d = 2.8;
%% 
% We will simulate the dipolar signal on a time-axis defined between -0.2$\mu 
% s$ and 4.0$\mu s$

t = linspace(-0.2,4,300);
r = time2dist(t);
%% 
% Now we can generate the signal with some added noise

%Generate the distance distribution
P = rd_onegaussian(r,[rmean w]);
%Generate the background
B = td_strexp(t,[k d]);
%Generate the signal
V = dipolarsignal(t,r,P,'moddepth',lam,'background',B,'noiselevel',0.01);

plot(t,V)
xlabel('time [\mus]'),ylabel('V(t)')
%% Defining the time-domain model
% This is probably the most crucial step: defining the model. How well a signal 
% can be fitted depends mainly on how well the model can describe our signal. 
% In order to fit our time-domain dipolar signal in one step, we require a model 
% which contains the information on the distance distribution, the background 
% and modlation depth. Even tough such a mode is not implemented as a function 
% in the program, we can easily define our own model using the built-in parametric 
% models.
% 
% In this case we know the groun truth, so we will construct our time-domain 
% model according to 
% 
% $$\mathit{\mathbf{V}}=\left(\left(1-\lambda \;\right)+\;\lambda \textrm{KP}\right)\odot 
% \mathit{\mathbf{B}}\;$$
% 
% where the background $\mathbf{B}$ will be modeled by a stretched exponential 
% time-domain model (|td_strexp|) and the distribution $\mathbf{P}$ will be modeled 
% by a single Gaussian distribution (|rd_onegaussian|)
% 
% We can build the model by defining an anonymous function handle |model|, which 
% must first accept the time axis |t| and the parameters |par|. The parameters 
% of our model must be defined on a vector |par|
%% 
% * |par(1) -> lam|
% * |par(2) -> rmean|
% * |par(3) -> w|
% * |par(4) -> k|
% * |par(5) -> d|

%Define our time-domain model
model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*rd_onegaussian(r,par(2:3))).*td_strexp(t,par(4:5));
%% Fitting the model
% At this point our model is ready to be fitted. The only remaining step remaining 
% is to define the initial values of the model parameters. Since it is a custom 
% model, all parameter values will be unbounded so it is recommended to set some 
% upper/lower boundaries for them. All three values can be defined as vectors 
% with the same order as in the |par| vector. All these values can be well-estimated 
% by visual inspection of the data.

% Parameter lam rmean  w   k   d
% Index      1    2    3   4   5
par0 =     [0.35 4.0 0.4  0.1 3.0];
lower =    [0.10 2.0 0.1  0.0 2.0];
upper =    [0.50 7.0 0.5  0.3 4.0];
%% 
% Finally we can launch the fitting function to obtain our fitted model parameters.

%Launch the fit
fitpar = fitparamodel(V,model,t,par0,'lower',lower,'upper',upper);
%% 
% We can now obtain the fitted models, and compare the fit parameters to our 
% input parameters:

%Get the fits
Vfit = model(t,fitpar);
Pfit = rd_onegaussian(r,fitpar(2:3));

%Plot results
subplot(121)
plot(t,V,'k.',t,Vfit)
subplot(122)
plot(r,P,'k',r,Pfit)

round(par,2)
round(fitpar,2)
##### SOURCE END #####
--></body></html>