<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB R2019b"><title>Fitting a custom time-domain model of a 4-pulse DEER signal</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(213, 80, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S2 { margin: 20px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F7F7F7; margin: 10px 0 10px 0;}
.S3 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 1px solid rgb(233, 233, 233); border-bottom: 0px none rgb(0, 0, 0); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S4 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 0px none rgb(0, 0, 0); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S5 { border-left: 1px solid rgb(233, 233, 233); border-right: 1px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 1px solid rgb(233, 233, 233); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 16.996px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S6 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S7 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: center;  }
.S8 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S9 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Fitting a custom time-domain model of a 4-pulse DEER signal</span></h1><div  class = 'S1'><span>Author: Luis Fabregas In this example we will construct a time-domain parametric model describing our full 4-pulse DEER signal (that means distribution + background + other time-domain parameters) using the built-in parametric models. We will then use this model to fit our full parametric model to our signal in one step.</span></div><h2  class = 'S2'><span>Generating a dipolar signal</span></h2><div  class = 'S1'><span>Let's start by simulating a dipolar signal, whose parameters we know. For this example we will use a dipolar signal with a modulation depth of 27% originating from a Gaussian distance distribution (mean distance of 3.5</span><span> </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span> and width of 0.3</span><span> </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span>) with a stretched exponential background model with a decay rate of 0.15$\mu s^{-1}$ and a dimensionality of 2.8.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span>clc,clf,clear</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Define the parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>rmean = 3.5; </span><span style="color: rgb(60, 118, 61);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>w = 0.3; </span><span style="color: rgb(60, 118, 61);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>lam = 0.27;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>k = 0.15; </span><span style="color: rgb(60, 118, 61);">%us-1</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>d = 2.8;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>par = [lam rmean w k d];</span></span></div></div></div><div  class = 'S1'><span>We will simulate the dipolar signal on a time-axis defined between -0.2$\mu s$ and 4.0$\mu s$</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span>t = linspace(-0.2,4,300);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>r = time2dist(t);</span></span></div></div></div><div  class = 'S1'><span>Now we can generate the signal with some added noise</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the distance distribution</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>P = dd_onegauss(r,[rmean w]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the background</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>B = bg_strexp(t,[k d]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Generate the signal</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>V = dipolarsignal(t,r,P,</span><span style="color: rgb(160, 32, 240);">'moddepth'</span><span>,lam,</span><span style="color: rgb(160, 32, 240);">'background'</span><span>,B,</span><span style="color: rgb(160, 32, 240);">'noiselevel'</span><span>,0.01);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>plot(t,V)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>xlabel(</span><span style="color: rgb(160, 32, 240);">'time [\mus]'</span><span>),ylabel(</span><span style="color: rgb(160, 32, 240);">'V(t)'</span><span>)</span></span></div></div></div><h2  class = 'S6'><span>Defining the time-domain model</span></h2><div  class = 'S1'><span>This is probably the most crucial step: defining the model. How well a signal can be fitted depends mainly on how well the model can describe our signal. In order to fit our time-domain dipolar signal in one step, we require a model which contains the information on the distance distribution, the background and modlation depth. Even tough such a mode is not implemented as a function in the program, we can easily define our own model using the built-in parametric models.</span></div><div  class = 'S1'><span>In this case we know the groun truth, so we will construct our time-domain model according to </span></div><div  class = 'S7'><span texencoding="\mathit{\mathbf{V}}=\left(\left(1-\lambda \;\right)+\;\lambda \textrm{KP}\right)\odot 
\mathit{\mathbf{B}}\;" style="vertical-align:-5px"><img src="data:image/png;base64,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" width="170" height="19" /></span></div><div  class = 'S1'><span>where the background</span><span> </span><span texencoding="\mathbf{B}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAkCAYAAACXOioTAAABzUlEQVRIS+3WT4RWURgG8N8YSkZat2m0yqymFsksaxGzqDaR0TRTi2Q2MaJNMmSiIolKi8RoRmmIZhFJ1KJFi+nfpnWUKI1IMkR5OXHcvvvN/b65vjTmcjfnz/Oc85znfc7p0qGvq0M8VonaVnrlS7cPJ7AV6xvotIA32IQP6X+CB3iPX2XaNpIu2nbiJnqzia8xhLdYi2FcyhZ0DacRi/nrKzujDbiB/dmMhziIL6mtB1dwOBsTZCfxvchURrQurfZYE6LoGsFUNuYbBvGsbqIDuFMADUln6ibai/udIIozm86IPmIP5uvcUTjvAo5noGGOMMOPuoiK9g5LT+J6I5IgbcV1UT93U20NYAve4Sxm8bVZELZC9DyBhoX7cATbE3j0XcY9LLZSsFXqKCLqPMYy4Fspwj7XdUZ/cDbjNnZkwBdxqrizVqQrRlBgr8E5jC9l8eUSBX4E6Zmliva/IYqFTqQ/39RuPMoblrujcN5VHMpA53AUn6oQVbmPAmdXyrqNCTQKeBRPq9i77IaNwIz75zG6E0lkXX8CjfbIuRdVCjbeDKH5tmZxkvoiIV6l1YdcL/GzbN7Kf25VUKy9IavStadbkxu2bcB/bu/fJKl9JePlgUUAAAAASUVORK5CYII=" width="13" height="18" /></span><span> will be modeled by a stretched exponential time-domain model </span><span>(</span><span style=' font-family: monospace;'>bg_strexp</span><span>) and the distribution</span><span> </span><span texencoding="\mathbf{P}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAkCAYAAACTz/ouAAABdUlEQVRIS+3WIUidURQH8J8rpoWxZlkatq0Oi8qQRa0yliYaBMGtGESYJgUxW2QqCoOB2HRFDIJNTKJlGxYVDLKwIOo4ch9cHu/tU54vqO+kj/Ode/6c//mfc2+TOltTnfNrABQy/PAo6sYI3hTWzjaOsIl17OOy/FwlisLXg3k8zQ5s4CN+4ln6HstiFjCKwxykWg9asISOLHgWw/ibfM2YwlAWs4oBHJd81QCeJ4B3/wGIX134UUbLZ8zgKvy1ArzCd7zMQBYxiD93AdCKb3idAUTD3+O0XgBRUR/O7gIg5Bw9yNU2gS+4qBUg+heqms7o2UUv9mpVUSTvxBxepGS/8QkrJQXdtoItrCXlteNtShxqCd7H8esmkxwxleagBHCe+A0aTnBQamil9VLrHBSurAbAI6YohmcZbdW2ZCE3KaCSip7gA76WJQnd9yPm4XrX38TKAeJOnkSs4Wq2k5ZZ3F6F9vCeLYUl3zagQVEhY/efon8CqGclCfN3YAAAAABJRU5ErkJggg==" width="12" height="18" /></span><span> will be modeled by a single Gaussian distribution </span><span>(</span><span style=' font-family: monospace;'>dd_onegauss</span><span>)</span></div><div  class = 'S1'><span>We can build the model by defining an anonymous function handle</span><span> </span><span style=' font-family: monospace;'>model</span><span>, which must first accept the time axis</span><span> </span><span style=' font-family: monospace;'>t</span><span> and the parameters</span><span> </span><span style=' font-family: monospace;'>par</span><span>. The parameters of our model must be defined on a vector</span><span> </span><span style=' font-family: monospace;'>par</span></div><ul  class = 'S8'><li  class = 'S9'><span style=' font-family: monospace;'>par(1) -&gt; lam</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(2) -&gt; rmean</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(3) -&gt; w</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(4) -&gt; k</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(5) -&gt; d</span></li></ul><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Define our time-domain model</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*dd_onegauss(r,par(2:3))).*bg_strexp(t,par(4:5));</span></span></div></div></div><h2  class = 'S6'><span>Fitting the model</span></h2><div  class = 'S1'><span>At this point our model is ready to be fitted. The only remaining step remaining is to define the initial values of the model parameters. Since it is a custom model, all parameter values will be unbounded so it is recommended to set some upper/lower boundaries for them. All three values can be defined as vectors with the same order as in the</span><span> </span><span style=' font-family: monospace;'>par</span><span> vector. All these values can be well-estimated by visual inspection of the data.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">% Parameter lam rmean  w   k   d</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">% Index      1    2    3   4   5</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>par0 =     [0.35 4.0 0.4  0.1 3.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>lower =    [0.10 2.0 0.1  0.0 2.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>upper =    [0.50 7.0 0.5  0.3 4.0];</span></span></div></div></div><div  class = 'S1'><span>Finally we can launch the fitting function to obtain our fitted model parameters.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Launch the fit</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>fitpar = fitparamodel(V,model,t,par0,</span><span style="color: rgb(160, 32, 240);">'lower'</span><span>,lower,</span><span style="color: rgb(160, 32, 240);">'upper'</span><span>,upper);</span></span></div></div></div><div  class = 'S1'><span>We can now obtain the fitted models, and compare the fit parameters to our input parameters:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Get the fits</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>Vfit = model(t,fitpar);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>Pfit = dd_onegauss(r,fitpar(2:3));</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(60, 118, 61);">%Plot results</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>subplot(121)</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>plot(t,V,</span><span style="color: rgb(160, 32, 240);">'k.'</span><span>,t,Vfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>subplot(122)</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>plot(r,P,</span><span style="color: rgb(160, 32, 240);">'k'</span><span>,r,Pfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>round(par,2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>round(fitpar,2)</span></span></div></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Fitting a custom time-domain model of a 4-pulse DEER signal
% Author: Luis Fabregas In this example we will construct a time-domain parametric 
% model describing our full 4-pulse DEER signal (that means distribution + background 
% + other time-domain parameters) using the built-in parametric models. We will 
% then use this model to fit our full parametric model to our signal in one step.
%% Generating a dipolar signal
% Let's start by simulating a dipolar signal, whose parameters we know. For 
% this example we will use a dipolar signal with a modulation depth of 27% originating 
% from a Gaussian distance distribution (mean distance of 3.5 $nm$ and width of 
% 0.3 $nm$) with a stretched exponential background model with a decay rate of 
% 0.15$\mu s^{-1}$ and a dimensionality of 2.8.

clc,clf,clear

%Define the parameters
rmean = 3.5; %nm
w = 0.3; %nm
lam = 0.27;
k = 0.15; %us-1
d = 2.8;

par = [lam rmean w k d];
%% 
% We will simulate the dipolar signal on a time-axis defined between -0.2$\mu 
% s$ and 4.0$\mu s$

t = linspace(-0.2,4,300);
r = time2dist(t);
%% 
% Now we can generate the signal with some added noise

%Generate the distance distribution
P = dd_onegauss(r,[rmean w]);
%Generate the background
B = bg_strexp(t,[k d]);
%Generate the signal
V = dipolarsignal(t,r,P,'moddepth',lam,'background',B,'noiselevel',0.01);

plot(t,V)
xlabel('time [\mus]'),ylabel('V(t)')
%% Defining the time-domain model
% This is probably the most crucial step: defining the model. How well a signal 
% can be fitted depends mainly on how well the model can describe our signal. 
% In order to fit our time-domain dipolar signal in one step, we require a model 
% which contains the information on the distance distribution, the background 
% and modlation depth. Even tough such a mode is not implemented as a function 
% in the program, we can easily define our own model using the built-in parametric 
% models.
% 
% In this case we know the groun truth, so we will construct our time-domain 
% model according to 
% 
% $$\mathit{\mathbf{V}}=\left(\left(1-\lambda \;\right)+\;\lambda \textrm{KP}\right)\odot 
% \mathit{\mathbf{B}}\;$$
% 
% where the background $\mathbf{B}$ will be modeled by a stretched exponential 
% time-domain model (|bg_strexp|) and the distribution $\mathbf{P}$ will be modeled 
% by a single Gaussian distribution (|dd_onegauss|)
% 
% We can build the model by defining an anonymous function handle |model|, which 
% must first accept the time axis |t| and the parameters |par|. The parameters 
% of our model must be defined on a vector |par|
%% 
% * |par(1) -> lam|
% * |par(2) -> rmean|
% * |par(3) -> w|
% * |par(4) -> k|
% * |par(5) -> d|

%Define our time-domain model
model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*dd_onegauss(r,par(2:3))).*bg_strexp(t,par(4:5));
%% Fitting the model
% At this point our model is ready to be fitted. The only remaining step remaining 
% is to define the initial values of the model parameters. Since it is a custom 
% model, all parameter values will be unbounded so it is recommended to set some 
% upper/lower boundaries for them. All three values can be defined as vectors 
% with the same order as in the |par| vector. All these values can be well-estimated 
% by visual inspection of the data.

% Parameter lam rmean  w   k   d
% Index      1    2    3   4   5
par0 =     [0.35 4.0 0.4  0.1 3.0];
lower =    [0.10 2.0 0.1  0.0 2.0];
upper =    [0.50 7.0 0.5  0.3 4.0];
%% 
% Finally we can launch the fitting function to obtain our fitted model parameters.

%Launch the fit
fitpar = fitparamodel(V,model,t,par0,'lower',lower,'upper',upper);
%% 
% We can now obtain the fitted models, and compare the fit parameters to our 
% input parameters:

%Get the fits
Vfit = model(t,fitpar);
Pfit = dd_onegauss(r,fitpar(2:3));

%Plot results
subplot(121)
plot(t,V,'k.',t,Vfit)
subplot(122)
plot(r,P,'k',r,Pfit)

round(par,2)
round(fitpar,2)
##### SOURCE END #####
--></body></html>